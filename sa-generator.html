<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>SV Tillmitsch – Schularbeits-Generator (1. Klasse Gym)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 80px 24px 24px 24px; /* Platz fürs Menü */
    max-width: 900px;
    background: #111;
    color: #eee;
  }

  /* Top-Menü */
  .top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #000;
    border-bottom: 2px solid #d4af37;
    z-index: 1000;
  }
  .top-nav-inner {
    max-width: 900px;
    margin: 0 auto;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .top-nav-title {
    font-weight: bold;
    color: #d4af37;
    margin-right: 16px;
  }
  .top-nav-link {
    color: #fff;
    text-decoration: none;
    font-size: 0.95em;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .top-nav-link:hover {
    background: #222;
  }
  .top-nav-link.active {
    background: #d4af37;
    color: #000;
  }

  h1 {
    text-align: center;
    color: #d4af37;
    text-shadow: 1px 1px #000;
    margin-bottom: 5px;
  }
  h2 {
    margin-top: 24px;
    color: #ff7f00;
    border-bottom: 3px solid #d4af37;
    padding-bottom: 4px;
  }
  img.logo {
    width: 150px;
    display: block;
    margin: 10px auto 20px auto;
  }
  .controls {
    margin: 12px 0 18px 0;
    padding: 10px;
    border: 1px solid #444;
    border-radius: 6px;
    background: #1b1b1b;
  }
  .controls-row {
    margin-bottom: 8px;
  }
  .topic-select {
    margin-top: 8px;
    font-size: 0.9em;
  }
  .topic-select label {
    display: inline-block;
    margin-right: 10px;
    margin-top: 4px;
  }
  select {
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #d4af37;
    background: #000;
    color: #eee;
  }
  input[type="text"], input[type="number"] {
    padding: 4px 6px;
    border-radius: 4px;
    border: 1px solid #d4af37;
    background: #000;
    color: #eee;
  }
  input[type="number"] {
    width: 50px;
  }
  button {
    background: #ff7f00;
    color: #000;
    padding: 6px 12px;
    border: none;
    margin: 6px 6px 6px 0;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
  }
  button:active {
    transform: scale(0.97);
  }
  button:disabled {
    opacity: 0.6;
    cursor: default;
  }
  .sheet {
    background: #fff;
    color: #000;
    padding: 16px 18px;
    margin-top: 10px;
    border-radius: 4px;
  }
  .header-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
    font-size: 0.9em;
  }
  .header-table td {
    border: 1px solid #000;
    padding: 4px 6px;
  }
  .task {
    margin-top: 10px;
    margin-bottom: 10px;
  }
  .task-number {
    font-weight: bold;
  }
  .points {
    font-weight: normal;
    font-size: 0.9em;
  }
  .solution-block {
    margin-top: 4px;
    padding-left: 10px;
  }
  .hint {
    font-size: 0.9em;
    color: #ccc;
    margin-bottom: 4px;
  }
  .timer {
    margin-left: 10px;
    font-weight: bold;
    color: #ffdf80;
  }
  .templates-list {
    font-size: 0.9em;
    border-top: 1px solid #333;
    padding-top: 6px;
    margin-top: 6px;
  }
  .template-item {
    margin-bottom: 4px;
  }

  @media print {
    body {
      background: #fff;
      color: #000;
      margin: 0;
      max-width: 100%;
    }
    .controls, .top-nav {
      display: none !important;
    }
    .sheet {
      border-radius: 0;
      margin: 0;
      padding: 10mm 12mm;
    }
  }
</style>
</head>
<body>

<!-- Panthers-Menü -->
<div class="top-nav">
  <div class="top-nav-inner">
    <span class="top-nav-title">SV Tillmitsch</span>
    <a class="top-nav-link" href="index.html">Mathe-Trainer</a>
    <a class="top-nav-link" href="textaufgaben.html">Textaufgaben</a>
    <a class="top-nav-link active" href="sa-generator.html">Schularbeit</a>
  </div>
</div>

<h1>SV Tillmitsch – Schularbeits-Generator</h1>
<img src="logo.png" alt="SV Tillmitsch Logo" class="logo">

<div class="controls">
  <div class="controls-row">
    <strong>Schwierigkeitsgrad:</strong>
    <select id="levelSelect">
      <option value="standard">Standard (1. Klasse Gym)</option>
      <option value="advanced">Schwer</option>
    </select>
  </div>

  <div class="topic-select">
    <strong>Themen auswählen:</strong><br>
    <label><input type="checkbox" class="topic-checkbox" data-key="1.1" checked> Zahlen &amp; Zählen</label>
    <label><input type="checkbox" class="topic-checkbox" data-key="1.2" checked> Zahlensysteme</label>
    <label><input type="checkbox" class="topic-checkbox" data-key="1.3" checked> Zahlen ordnen</label>
    <label><input type="checkbox" class="topic-checkbox" data-key="1.4" checked> Runden</label><br>
    <label><input type="checkbox" class="topic-checkbox" data-key="2.1" checked> Addieren &amp; Subtrahieren</label>
    <label><input type="checkbox" class="topic-checkbox" data-key="2.2" checked> Multiplizieren &amp; Dividieren</label>
    <label><input type="checkbox" class="topic-checkbox" data-key="2.3" checked> Verbundene Aufgaben</label>
    <label><input type="checkbox" class="topic-checkbox" data-key="T" checked> Textaufgaben</label>
  </div>

  <div class="controls-row">
    <strong>Anzahl Aufgaben pro Thema:</strong><br>
    <label>1.1 Zahlen &amp; Zählen: 
      <input type="number" class="topic-count" data-key="1.1" min="0" max="20" value="2">
    </label>
    <label>1.2 Zahlensysteme: 
      <input type="number" class="topic-count" data-key="1.2" min="0" max="20" value="2">
    </label>
    <label>1.3 Zahlen ordnen: 
      <input type="number" class="topic-count" data-key="1.3" min="0" max="20" value="2">
    </label>
    <label>1.4 Runden: 
      <input type="number" class="topic-count" data-key="1.4" min="0" max="20" value="2">
    </label><br>
    <label>2.1 Addieren &amp; Subtrahieren: 
      <input type="number" class="topic-count" data-key="2.1" min="0" max="20" value="2">
    </label>
    <label>2.2 Multiplizieren &amp; Dividieren: 
      <input type="number" class="topic-count" data-key="2.2" min="0" max="20" value="2">
    </label>
    <label>2.3 Verbundene Aufgaben: 
      <input type="number" class="topic-count" data-key="2.3" min="0" max="20" value="2">
    </label>
    <label>Textaufgaben: 
      <input type="number" class="topic-count" data-key="T" min="0" max="20" value="4">
    </label>
  </div>

  <div class="controls-row">
    <strong>Seed:</strong>
    <input type="text" id="seedInput" style="width: 110px;">
    <button id="useSeedBtn">Mit Seed erzeugen</button>
  </div>

  <div class="controls-row">
    <button id="generateBtn">Neue Schularbeit erstellen</button>
    <button id="printBtn">Als PDF drucken</button>
  </div>

  <div class="controls-row">
    <button id="examStartBtn">SA-Modus 50 Minuten starten</button>
    <button id="examStopBtn">SA-Modus beenden</button>
    <span id="timerDisplay" class="timer"></span>
  </div>

  <div class="controls-row">
    <strong>Vorlagen (Lehrer-Modus):</strong><br>
    <input type="text" id="templateNameInput" placeholder="Name der Vorlage" style="width: 180px;">
    <button id="saveTemplateBtn">Aktuelle SA als Vorlage speichern</button>
    <div id="templatesList" class="templates-list"></div>
  </div>

  <div class="hint">
    Level, Themen und Aufgabenanzahl werden im Browser gespeichert.  
    SA-Modus blendet das Lösungsblatt aus und startet einen 50-Minuten-Timer.  
    Vorlagen speichern: Seed + Themen + Aufgabenanzahl + Level bleiben erhalten.
  </div>
</div>

<h2>Schularbeit – Aufgabenblatt</h2>
<div id="saSheet" class="sheet"></div>

<h2 id="solutionTitle">Lösungsblatt</h2>
<div id="solutionSheet" class="sheet"></div>

<script>
  // Punkte pro Aufgabe je Thema
  const POINTS_CONFIG = {
    "1.1": 2,
    "1.2": 2,
    "1.3": 2,
    "1.4": 2,
    "2.1": 3,
    "2.2": 3,
    "2.3": 4,
    "T":   5
  };

  const sectionOrder = [
    {key:"1.1", title:"1. Zahlen & Zählen"},
    {key:"1.2", title:"2. Zahlensysteme"},
    {key:"1.3", title:"3. Zahlen ordnen"},
    {key:"1.4", title:"4. Runden"},
    {key:"2.1", title:"5. Addieren & Subtrahieren"},
    {key:"2.2", title:"6. Multiplizieren & Dividieren"},
    {key:"2.3", title:"7. Verbundene Aufgaben"},
    {key:"T",   title:"8. Textaufgaben"}
  ];

  let currentLevel = "standard";
  let currentSeed = null;
  let rng = null;
  let examMode = false;
  let timerId = null;
  let remainingSeconds = 0;
  let currentExamConfig = null; // für Vorlagen

  let templates = []; // gespeicherte SAs

  // PRNG mit Seed (mulberry32)
  function mulberry32(a) {
    return function() {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }
  function reseed(seed) {
    currentSeed = seed;
    rng = mulberry32(seed >>> 0);
  }
  function rand() {
    return rng ? rng() : Math.random();
  }
  function randInt(min, max) {
    return Math.floor(rand() * (max - min + 1)) + min;
  }
  function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(rand() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
  }

  function intToRoman(num) {
    const vals=[1000,900,500,400,100,90,50,40,10,9,5,4,1];
    const syms=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];
    let res=""; for(let i=0;i<vals.length;i++){while(num>=vals[i]){num-=vals[i];res+=syms[i];}}
    return res;
  }
  function divisors(n){let r=[];for(let i=1;i<=n;i++){if(n%i===0)r.push(i);}return r;}
  function multiples(b,c){let r=[];for(let i=1;i<=c;i++)r.push(b*i);return r;}

  const textTasksStandard = [
    {q:"Bei einem Turnier schießt eine Mannschaft in fünf Spielen 3, 2, 4, 1 und 3 Tore. Wie viele Tore sind das insgesamt?", a:"3 + 2 + 4 + 1 + 3 = 13 Tore"},
    {q:"18 Spieler bekommen je 2 Trinkflaschen mit 0,5 Litern. Wie viele Liter Wasser sind das insgesamt?", a:"18 · 2 · 0,5 = 18 Liter"},
    {q:"Zwei Busse haben je 48 Plätze. 67 Kinder fahren mit. Wie viele Plätze bleiben frei?", a:"2 · 48 = 96 Plätze, 96 − 67 = 29 freie Plätze"},
    {q:"Kevin hat 125 Sticker. Er verschenkt 37 und kauft 24 neue dazu. Wie viele Sticker hat er danach?", a:"125 − 37 + 24 = 112 Sticker"},
    {q:"Ein Training dauert 90 Minuten. Die Mannschaft trainiert an 4 Tagen. Wie viele Stunden Training sind das insgesamt?", a:"4 · 90 = 360 Minuten = 6 Stunden"},
    {q:"Eine Laufstrecke ist 400 m lang. Ein Spieler läuft 6 Runden. Wie viele Kilometer läuft er?", a:"6 · 400 = 2400 m = 2,4 km"},
    {q:"Beim Turnier gibt es 3 Punkte für einen Sieg und 1 Punkt für ein Unentschieden. Eine Mannschaft hat 3 Siege, 2 Unentschieden und 1 Niederlage. Wie viele Punkte hat sie?", a:"3 · 3 + 2 · 1 = 11 Punkte"},
    {q:"Eine Tribüne hat 18 Reihen mit je 25 Plätzen. Wie viele Zuschauer passen maximal auf diese Tribüne?", a:"18 · 25 = 450 Zuschauer"},
    {q:"In 4 Kisten liegen je 12 Äpfel, in 3 Kisten je 10 Birnen. Wie viele Früchte sind das insgesamt?", a:"4 · 12 + 3 · 10 = 48 + 30 = 78 Früchte"},
    {q:"26 Kinder zahlen je 3 € in die Klassenkasse ein. Wie viel Geld kommt zusammen?", a:"26 · 3 = 78 €"}
  ];

  const textTasksAdvanced = [
    {q:"Bei einem Trainingslager trainiert die Mannschaft 5 Tage lang. Jeden Tag gibt es am Vormittag 90 Minuten und am Nachmittag 75 Minuten Training. Wie viele Minuten Training sind das insgesamt?", a:"(90 + 75) · 5 = 165 · 5 = 825 Minuten"},
    {q:"Eine Klasse sammelt für neue Bälle. 24 Kinder zahlen je 7 €, 5 Kinder zahlen je 10 €. Wie viel Geld wird gesammelt?", a:"24 · 7 + 5 · 10 = 168 + 50 = 218 €"},
    {q:"Für neue Dressen werden 18 Trikots um je 29 € und 18 Hosen um je 19 € gekauft. Wie viel kostet das insgesamt?", a:"18 · 29 + 18 · 19 = 18 · 48 = 864 €"},
    {q:"Ein Spielfeld ist 105 m lang und 68 m breit. Wie viele Meter läuft ein Linienrichter, wenn er einmal komplett rund um das Feld geht?", a:"2 · (105 + 68) = 2 · 173 = 346 m"},
    {q:"Beim Turnier hat jede der 6 Mannschaften genau 4 Spiele. Wie viele Spiele finden insgesamt statt? (Jedes Spiel hat zwei Mannschaften.)", a:"6 · 4 ÷ 2 = 24 ÷ 2 = 12 Spiele"},
    {q:"Ein Verein verkauft 125 Fanschals um je 18 € und 80 Hauben um je 12 €. Wie viel Geld nimmt der Verein ein?", a:"125 · 18 + 80 · 12 = 2250 + 960 = 3210 €"},
    {q:"Auf einer Tribüne sind 27 Reihen mit je 32 Sitzen. Bei einem Spiel sind 718 Plätze besetzt. Wie viele Plätze bleiben frei?", a:"27 · 32 = 864 Plätze, 864 − 718 = 146 freie Plätze"},
    {q:"Beim Laufevent läuft jede der 48 Personen 2,5 km. Wie viele Kilometer werden insgesamt gelaufen?", a:"48 · 2,5 = 120 km"}
  ];

  // Aufgabenanzahl aus Inputs
  function getTaskCount(key) {
    const input = document.querySelector('.topic-count[data-key="'+key+'"]');
    if (!input) return 0;
    let v = parseInt(input.value, 10);
    if (isNaN(v) || v < 0) v = 0;
    return v;
  }

  // Generatoren benutzen getTaskCount(key)
  const generators = {
    "1.1": lvl=>{
      const cnt = getTaskCount("1.1");
      const t=[]; for(let i=0;i<cnt*2;i++){
        const n=lvl==="advanced"?randInt(1000,999999):randInt(100,99999);
        t.push({q:"Vorgänger und Nachfolger von "+n, a:(n-1)+" / "+(n+1)});
      } shuffle(t); return t.slice(0,cnt);
    },
    "1.2": lvl=>{
      const cnt = getTaskCount("1.2");
      const t=[]; for(let i=0;i<cnt*3;i++){
        const typ=randInt(1,3);
        if(typ===1){
          const max=lvl==="advanced"?3999:2000;
          const n=randInt(10,max);
          t.push({q:n+" in römischen Zahlen",a:intToRoman(n)});
        } else if(typ===2){
          const max=lvl==="advanced"?3999:2000;
          const n=randInt(10,max), r=intToRoman(n);
          t.push({q:r+" als Zahl",a:""+n});
        } else {
          const n=lvl==="advanced"?randInt(100000,9999999):randInt(1000,999999);
          const s=n.toString(), len=s.length;
          if(lvl==="advanced"){
            const posNames=["Einer","Zehner","Hunderter","Tausender","Zehntausender","Hunderttausender","Millionen"];
            const pos=randInt(0,len-1), stelle=posNames[pos];
            t.push({q:"Welche Ziffer steht an der "+stelle+"-Stelle von "+n+"?",a:s[len-1-pos]});
          } else {
            const t1=Math.floor(n/1000), h=Math.floor((n%1000)/100), z=Math.floor((n%100)/10), e=n%10;
            t.push({q:n+" zerlegen (T/H/Z/E)",a:t1+" T, "+h+" H, "+z+" Z, "+e+" E"});
          }
        }
      } shuffle(t); return t.slice(0,cnt);
    },
    "1.3": lvl=>{
      const cnt = getTaskCount("1.3");
      const t=[]; for(let i=0;i<cnt*3;i++){
        if(randInt(1,2)===1){
          const a=lvl==="advanced"?randInt(10000,9999999):randInt(1000,99999);
          const b=lvl==="advanced"?randInt(10000,9999999):randInt(1000,99999);
          const sign=a>b?">":a<b?"<":"=";
          t.push({q:a+" __ "+b,a:sign});
        } else {
          const count=lvl==="advanced"?7:5;
          const min=lvl==="advanced"?10000:1000, max=lvl==="advanced"?9999999:99999;
          let arr=[]; for(let k=0;k<count;k++) arr.push(randInt(min,max));
          const sorted=arr.slice().sort((x,y)=>x-y);
          t.push({q:"Sortiere: "+arr.join(", "),a:sorted.join(", ")});
        }
      } shuffle(t); return t.slice(0,cnt);
    },
    "1.4": lvl=>{
      const cnt = getTaskCount("1.4");
      const t=[]; for(let i=0;i<cnt*3;i++){
        const mode = randInt(1,lvl==="advanced"?4:3);
        let n,a,q;
        if(mode===1){n=lvl==="advanced"?randInt(100,99999):randInt(0,9999);a=Math.round(n/10)*10;q="Runde "+n+" auf Zehner";}
        else if(mode===2){n=lvl==="advanced"?randInt(1000,999999):randInt(0,99999);a=Math.round(n/100)*100;q="Runde "+n+" auf Hunderter";}
        else if(mode===3){n=lvl==="advanced"?randInt(5000,999999):randInt(0,999999);a=Math.round(n/1000)*1000;q="Runde "+n+" auf Tausender";}
        else {n=randInt(10000,9999999);a=Math.round(n/10000)*10000;q="Runde "+n+" auf Zehntausender";}
        t.push({q,a:""+a});
      } shuffle(t); return t.slice(0,cnt);
    },
    "2.1": lvl=>{
      const cnt = getTaskCount("2.1");
      const t=[]; for(let i=0;i<cnt*3;i++){
        const typ=randInt(1,3); let q,res;
        if(typ===1){const a=randInt(100,5000),b=randInt(100,5000);q=a+" + "+b;res=a+b;}
        else if(typ===2){const a=lvl==="advanced"?randInt(1000,9000):randInt(500,5000),b=randInt(100,a-100),c=randInt(10,200);q="("+a+" - "+b+") + "+c;res=(a-b)+c;}
        else {const a=randInt(500,10000),b=randInt(100,a-100),c=randInt(50,b);q=a+" - ("+b+" - "+c+")";res=a-(b-c);}
        t.push({q,a:""+res});
      } shuffle(t); return t.slice(0,cnt);
    },
    "2.2": lvl=>{
      const cnt = getTaskCount("2.2");
      const t=[]; for(let i=0;i<cnt*3;i++){
        const typ=randInt(1,3);
        if(typ===1){
          const n=lvl==="advanced"?randInt(50,200):randInt(20,120);
          t.push({q:"Alle Teiler von "+n,a:divisors(n).join(", ")});
        } else if(typ===2){
          const b=lvl==="advanced"?randInt(7,20):randInt(3,12);
          t.push({q:"Erste 8 Vielfache von "+b,a:multiples(b,8).join(", ")});
        } else {
          const a=lvl==="advanced"?randInt(20,200):randInt(10,99);
          const b=lvl==="advanced"?randInt(10,30):randInt(2,12);
          if(rand()<0.5) t.push({q:a+"×"+b,a:""+(a*b)});
          else {const prod=a*b;t.push({q:prod+"÷"+a,a:""+b});}
        }
      } shuffle(t); return t.slice(0,cnt);
    },
    "2.3": lvl=>{
      const cnt = getTaskCount("2.3");
      const t=[]; for(let i=0;i<cnt*3;i++){
        const typ=randInt(1,3); let q,res;
        if(typ===1){
          const a=randInt(50,400),b=randInt(5,20),c=randInt(10,50);
          q=a+" + "+b+"×"+c;res=a+b*c;
        } else if(typ===2){
          const a=randInt(200,900),b=randInt(2,9),c=randInt(10,50);
          q="("+a+"÷"+b+") + "+c;res=Math.floor(a/b)+c;
        } else {
          const a=randInt(20,80),b=randInt(5,15),c=randInt(10,100);
          q="("+a+"×"+b+") - "+c;res=a*b-c;
        }
        t.push({q,a:""+res});
      } shuffle(t); return t.slice(0,cnt);
    },
    "T": lvl=>{
      const cnt = getTaskCount("T");
      const pool=(lvl==="advanced"?textTasksAdvanced.slice():textTasksStandard.slice());
      shuffle(pool);
      return pool.slice(0,cnt);
    }
  };

  function getActiveTopics() {
    return Array.from(document.querySelectorAll(".topic-checkbox"))
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.key);
  }

  function getCurrentCountsMap() {
    const map = {};
    sectionOrder.forEach(sec => {
      map[sec.key] = getTaskCount(sec.key);
    });
    return map;
  }

  function saveSaSettings() {
    localStorage.setItem("saLevel", currentLevel);
    localStorage.setItem("saTopics", JSON.stringify(getActiveTopics()));
    localStorage.setItem("saCounts", JSON.stringify(getCurrentCountsMap()));
  }

  function loadSaSettings() {
    const levelSelect = document.getElementById("levelSelect");
    const savedLevel = localStorage.getItem("saLevel");
    if (savedLevel && (savedLevel === "standard" || savedLevel === "advanced")) {
      currentLevel = savedLevel;
      levelSelect.value = savedLevel;
    } else {
      // falls nichts gespeichert: mit Trainer-Level synchronisieren, wenn vorhanden
      const trainerLevel = localStorage.getItem("trainerLevel");
      if (trainerLevel && (trainerLevel === "standard" || trainerLevel === "advanced")) {
        currentLevel = trainerLevel;
        levelSelect.value = trainerLevel;
      }
    }

    const savedTopics = localStorage.getItem("saTopics");
    if (savedTopics) {
      try {
        const arr = JSON.parse(savedTopics);
        const checkboxes = document.querySelectorAll(".topic-checkbox");
        checkboxes.forEach(cb => {
          cb.checked = arr.includes(cb.dataset.key);
        });
      } catch(e) {/* ignore */}
    }

    const savedCounts = localStorage.getItem("saCounts");
    if (savedCounts) {
      try {
        const map = JSON.parse(savedCounts);
        document.querySelectorAll(".topic-count").forEach(inp => {
          const k = inp.dataset.key;
          if (map.hasOwnProperty(k)) {
            inp.value = map[k];
          }
        });
      } catch(e) {/* ignore */}
    }

    const savedTemplates = localStorage.getItem("saTemplates");
    if (savedTemplates) {
      try {
        templates = JSON.parse(savedTemplates) || [];
      } catch(e) { templates = []; }
    }
    renderTemplatesList();
  }

  function updateTimerDisplay() {
    const el = document.getElementById("timerDisplay");
    if (!el) return;
    if (!examMode) {
      el.textContent = "";
      return;
    }
    const m = Math.floor(remainingSeconds / 60);
    const s = remainingSeconds % 60;
    el.textContent = "SA-Modus: " + m + ":" + (s<10?"0"+s:s);
  }

  function startExamMode() {
    if (examMode) return;
    examMode = true;
    remainingSeconds = 50 * 60;
    updateTimerDisplay();
    timerId = setInterval(function() {
      remainingSeconds--;
      if (remainingSeconds <= 0) {
        remainingSeconds = 0;
        updateTimerDisplay();
        stopExamMode("Zeit abgelaufen.");
      } else {
        updateTimerDisplay();
      }
    }, 1000);
    document.getElementById("solutionSheet").style.display = "none";
    document.getElementById("solutionTitle").style.display = "none";
    document.getElementById("generateBtn").disabled = true;
    document.getElementById("useSeedBtn").disabled = true;
  }

  function stopExamMode(message) {
    if (!examMode) return;
    examMode = false;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
    updateTimerDisplay();
    document.getElementById("solutionSheet").style.display = "block";
    document.getElementById("solutionTitle").style.display = "block";
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("useSeedBtn").disabled = false;
    if (message) alert(message);
  }

  document.getElementById("examStartBtn").addEventListener("click", function() {
    startExamMode();
  });
  document.getElementById("examStopBtn").addEventListener("click", function() {
    stopExamMode();
  });

  const levelSelect = document.getElementById("levelSelect");
  levelSelect.addEventListener("change", function () {
    currentLevel = this.value;
    saveSaSettings();
  });

  document.querySelectorAll(".topic-checkbox").forEach(cb=>{
    cb.addEventListener("change", saveSaSettings);
  });
  document.querySelectorAll(".topic-count").forEach(inp=>{
    inp.addEventListener("change", saveSaSettings);
  });

  document.getElementById("printBtn").addEventListener("click", function () {
    window.print();
  });

  document.getElementById("generateBtn").addEventListener("click", function () {
    generateExam(null);
  });

  document.getElementById("useSeedBtn").addEventListener("click", function () {
    const seedStr = document.getElementById("seedInput").value.trim();
    const seed = parseInt(seedStr, 10);
    if (isNaN(seed)) {
      alert("Bitte eine ganze Zahl als Seed eingeben.");
      return;
    }
    generateExam(seed);
  });

  function generateExam(seedParam) {
    const saDiv = document.getElementById("saSheet");
    const solDiv = document.getElementById("solutionSheet");
    saDiv.innerHTML = "";
    solDiv.innerHTML = "";

    const activeKeys = getActiveTopics();
    if (activeKeys.length === 0) {
      alert("Bitte mindestens ein Thema auswählen.");
      return;
    }

    // Seed festlegen
    let seed = parseInt(seedParam, 10);
    if (isNaN(seed)) {
      seed = Math.floor(Math.random() * 1000000000);
    }
    reseed(seed);
    const seedInput = document.getElementById("seedInput");
    if (seedInput) seedInput.value = seed;

    // Einstellungen speichern
    saveSaSettings();

    // Aufgabenanzahl pro Thema für diese SA
    const counts = {};
    activeKeys.forEach(k => {
      counts[k] = getTaskCount(k);
    });

    // Maximalpunkte berechnen
    let totalMaxPoints = 0;
    activeKeys.forEach(k => {
      const tasksCount = counts[k] || 0;
      const pointsPerTask = POINTS_CONFIG[k] || 0;
      totalMaxPoints += tasksCount * pointsPerTask;
    });

    saDiv.innerHTML += `
      <table class="header-table">
        <tr>
          <td><strong>Name:</strong></td>
          <td><strong>Klasse:</strong></td>
          <td><strong>Datum:</strong></td>
          <td><strong>Punkte:</strong> ____ / ${totalMaxPoints}<br><strong>Version:</strong> ${seed}</td>
        </tr>
      </table>
      <p><strong>Hinweis:</strong> Rechenschritte sauber anschreiben. Taschenrechner ist ${currentLevel==="advanced" ? "nicht erlaubt" : "nur nach Absprache erlaubt"}.</p>
    `;

    solDiv.innerHTML += `<p><strong>Lösungsblatt – Kontrolle</strong> (Maximal ${totalMaxPoints} Punkte, Version ${seed})</p>`;

    let taskNumber = 1;

    sectionOrder.forEach(sec => {
      if (!activeKeys.includes(sec.key)) return;
      const cnt = counts[sec.key] || 0;
      if (cnt <= 0) return;

      const tasks = generators[sec.key](currentLevel);
      if (!tasks || tasks.length === 0) return;

      const pointsPerTask = POINTS_CONFIG[sec.key] || 0;

      saDiv.innerHTML += `<p><strong>${sec.title}</strong></p>`;
      solDiv.innerHTML += `<p><strong>${sec.title}</strong></p>`;

      tasks.forEach(t => {
        const taskHtml = `
          <div class="task">
            <span class="task-number">${taskNumber}.)</span>
            <span class="points">(${pointsPerTask} P.)</span>
            <span> ${t.q}</span>
            <div style="min-height: 24px; border-bottom: 1px solid #000; margin-top: 4px;"></div>
          </div>
        `;
        saDiv.innerHTML += taskHtml;

        const solHtml = `
          <div class="task">
            <span class="task-number">${taskNumber}.)</span>
            <span class="points">(${pointsPerTask} P.)</span>
            <div class="solution-block">${t.a}</div>
          </div>
        `;
        solDiv.innerHTML += solHtml;

        taskNumber++;
      });
    });

    // aktuelle SA-Konfiguration für Vorlagen speichern
    currentExamConfig = {
      seed: seed,
      level: currentLevel,
      topics: activeKeys.slice(),
      counts: counts
    };
  }

  // Vorlagen-Funktionen
  function saveTemplatesToStorage() {
    localStorage.setItem("saTemplates", JSON.stringify(templates));
  }

  function renderTemplatesList() {
    const list = document.getElementById("templatesList");
    list.innerHTML = "";
    if (!templates || templates.length === 0) {
      list.textContent = "Noch keine Vorlagen gespeichert.";
      return;
    }
    templates.forEach(tpl => {
      const div = document.createElement("div");
      div.className = "template-item";
      const topicsShort = tpl.topics.join(", ");
      const spanText = document.createElement("span");
      spanText.textContent = tpl.name + " – Seed " + tpl.seed + " – Themen: " + topicsShort;
      div.appendChild(spanText);

      const btnLoad = document.createElement("button");
      btnLoad.type = "button";
      btnLoad.textContent = "Laden";
      btnLoad.style.marginLeft = "8px";
      btnLoad.onclick = function () {
        loadTemplate(tpl.id);
      };
      div.appendChild(btnLoad);

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.textContent = "Löschen";
      btnDel.onclick = function () {
        deleteTemplate(tpl.id);
      };
      div.appendChild(btnDel);

      list.appendChild(div);
    });
  }

  function saveCurrentAsTemplate() {
    if (!currentExamConfig) {
      alert("Bitte zuerst eine Schularbeit erzeugen, bevor du sie als Vorlage speicherst.");
      return;
    }
    const nameInput = document.getElementById("templateNameInput");
    let name = (nameInput.value || "").trim();
    if (!name) {
      name = "SA-" + new Date().toLocaleDateString();
    }

    const id = Date.now();
    const tpl = {
      id: id,
      name: name,
      seed: currentExamConfig.seed,
      level: currentExamConfig.level,
      topics: currentExamConfig.topics,
      counts: currentExamConfig.counts
    };
    templates.push(tpl);
    saveTemplatesToStorage();
    renderTemplatesList();
  }

  function loadTemplate(id) {
    const tpl = templates.find(t => t.id === id);
    if (!tpl) return;

    // Level
    currentLevel = tpl.level;
    document.getElementById("levelSelect").value = tpl.level;

    // Themen
    const checkboxes = document.querySelectorAll(".topic-checkbox");
    checkboxes.forEach(cb => {
      cb.checked = tpl.topics.includes(cb.dataset.key);
    });

    // Aufgabenanzahl
    document.querySelectorAll(".topic-count").forEach(inp => {
      const k = inp.dataset.key;
      if (tpl.counts && tpl.counts.hasOwnProperty(k)) {
        inp.value = tpl.counts[k];
      }
    });

    // Seed eintragen und SA erzeugen
    document.getElementById("seedInput").value = tpl.seed;
    saveSaSettings();
    generateExam(tpl.seed);
  }

  function deleteTemplate(id) {
    templates = templates.filter(t => t.id !== id);
    saveTemplatesToStorage();
    renderTemplatesList();
  }

  document.getElementById("saveTemplateBtn").addEventListener("click", function () {
    saveCurrentAsTemplate();
  });

  // Initial laden
  loadSaSettings();
  // einmal SA erzeugen
  generateExam(null);
</script>
</body>
</html>
