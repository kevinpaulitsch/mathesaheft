<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>GB English Trainer ‚Äì More! 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0;padding:10px;min-height:100vh}
    .box{max-width:500px;margin:20px auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    h2{text-align:center;color:#667eea}
    select,button,input{width:100%;padding:12px;margin:8px 0;font-size:16px;border-radius:8px}
    button{background:#667eea;color:#fff;border:none;font-weight:bold;cursor:pointer}
    button:disabled{background:#ccc}
    .btn-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn-error{grid-column:1/-1;background:#ff6b6b}
    .question{font-size:22px;font-weight:bold;text-align:center;margin:15px 0}
    .mc{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hide{display:none}
    .stats{display:flex;justify-content:space-around;margin-top:10px}
    .progress-bar{height:10px;background:#eee;border-radius:5px}
    .progress-fill{height:100%;background:#667eea;width:0%}
    .final-screen{text-align:center}
  </style>
</head>
<body>

<div class="box">
<h2>üá¨üáß GB English Trainer ‚Äì More! 1</h2>

<select id="unit">
  <option value="all">‚≠ê Alle Units</option>
  <option value="1">Unit 1</option>
  <option value="2">Unit 2</option>
  <option value="3">Unit 3</option>
  <option value="4">Unit 4</option>
  <option value="5">Unit 5</option>
  <option value="6">Unit 6</option>
  <option value="7">Unit 7</option>
</select>

<select id="direction">
  <option value="de-en">Deutsch ‚Üí Englisch</option>
  <option value="en-de">Englisch ‚Üí Deutsch</option>
  <option value="mix">Gemischt</option>
</select>

<select id="mode">
  <option value="write">‚úèÔ∏è Schreiben</option>
  <option value="mc">üéØ Multiple Choice</option>
</select>

<div class="btn-group">
  <button onclick="startTrainer()">‚ñ∂Ô∏è Trainer</button>
  <button onclick="startTest()">üìù Test</button>
  <button class="btn-error" onclick="startErrorTrainer()" id="errorBtn" disabled>
    üîÅ Fehler-Trainer (<span id="errorCount">0</span>)
  </button>
</div>

<div class="question" id="question">Bereit?</div>
<div class="mc" id="mc"></div>
<input id="answer" class="hide" placeholder="Antwort eingeben (Enter)">
<button id="okBtn" class="hide" onclick="checkAnswer()">OK</button>

<div class="stats hide" id="stats">
  <div>‚úÖ <span id="correctCount">0</span></div>
  <div>‚ùå <span id="wrongCount">0</span></div>
</div>

<div class="progress-bar hide" id="progressBar">
  <div class="progress-fill" id="progressFill"></div>
</div>

<div id="finalScreen" class="hide"></div>
</div>

<script src="vocab.js"></script>
<script src="grammar.js"></script>

<script>
let pool=[],current=null,wrong=[],correct=0,incorrect=0,totalQuestions=0,isActive=false;

/* ================== TEST LOGIK ================== */

function shuffle(a){return a.sort(()=>Math.random()-0.5)}

function getMixedTestPool(){
  const vocab=getVocabForUnit("all").map(v=>({type:"vocab",data:v}));
  const grammar=getGrammarTasks(30).map(g=>({type:"grammar",data:g}));
  return shuffle([...vocab,...grammar]).slice(0,30);
}

function getGrade(p){
  if(p>=90)return"Sehr gut (1)";
  if(p>=80)return"Gut (2)";
  if(p>=65)return"Befriedigend (3)";
  if(p>=50)return"Gen√ºgend (4)";
  return"Nicht gen√ºgend (5)";
}

/* ================== START ================== */

function startTrainer(){
  wrong=[];correct=0;incorrect=0;isActive=true;
  pool=getVocabForUnit(document.getElementById("unit").value);
  totalQuestions=pool.length;
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  nextQuestion();
}

function startTest(){
  wrong=[];correct=0;incorrect=0;isActive=true;
  pool=getMixedTestPool();
  totalQuestions=pool.length;
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  nextQuestion();
}

function startErrorTrainer(){
  pool=[...wrong];wrong=[];
  correct=0;incorrect=0;
  totalQuestions=pool.length;
  nextQuestion();
}

/* ================== FRAGEN ================== */

function nextQuestion(){
  if(pool.length===0){showFinal();return}
  document.getElementById("mc").innerHTML="";
  document.getElementById("answer").value="";
  current=pool[Math.floor(Math.random()*pool.length)];
  document.getElementById("progressFill").style.width=
    ((totalQuestions-pool.length)/totalQuestions*100)+"%";

  if(current.q){
    document.getElementById("question").innerText=current.q;
    showMC(current.options,current.a,true);
    return;
  }

  let q=current.de,a=current.en;
  const dir=document.getElementById("direction").value;
  if(dir==="en-de")[q,a]=[a,q];
  if(dir==="mix"&&Math.random()>0.5)[q,a]=[a,q];
  current.solution=a;
  document.getElementById("question").innerText=q;

  if(document.getElementById("mode").value==="mc"){
    showMC(a);
  }else{
    document.getElementById("answer").classList.remove("hide");
    document.getElementById("okBtn").classList.remove("hide");
    document.getElementById("answer").focus();
  }
}

function showMC(correct,isGrammar=false){
  const mc=document.getElementById("mc");
  let opts=[correct];
  while(opts.length<4){
    const r=pool[Math.floor(Math.random()*pool.length)];
    const c=r.en||r;
    if(!opts.includes(c))opts.push(c);
  }
  shuffle(opts).forEach(o=>{
    const b=document.createElement("button");
    b.innerText=o;
    b.onclick=()=>checkAnswer(o,isGrammar?correct:null);
    mc.appendChild(b);
  });
}

function checkAnswer(val=null,solution=null){
  const input=val||document.getElementById("answer").value.trim();
  const sol=solution||current.solution;
  if(!input)return;

  if(input.toLowerCase()===sol.toLowerCase()){
    correct++;
    pool=pool.filter(x=>x!==current);
  }else{
    incorrect++;
    if(!wrong.includes(current))wrong.push(current);
  }
  document.getElementById("correctCount").innerText=correct;
  document.getElementById("wrongCount").innerText=incorrect;
  document.getElementById("errorCount").innerText=wrong.length;
  document.getElementById("errorBtn").disabled=wrong.length===0;
  nextQuestion();
}

/* ================== ERGEBNIS ================== */

function showFinal(){
  const total=correct+incorrect;
  const percent=Math.round(correct/total*100);
  const grade=getGrade(percent);
  document.getElementById("finalScreen").innerHTML=`
    <div class="final-screen">
      <h3>Ergebnis</h3>
      <p>${correct}/${total} richtig (${percent}%)</p>
      <p><strong>Note: ${grade}</strong></p>
      <button onclick="location.reload()">Neu starten</button>
    </div>`;
  document.getElementById("finalScreen").classList.remove("hide");
}
document.getElementById("answer").addEventListener("keydown",e=>{
  if(e.key==="Enter")checkAnswer();
});
</script>
</body>
</html>
