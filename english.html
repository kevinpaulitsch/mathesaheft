<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>GB English Trainer â€“ More! 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 0;
      min-height: 100vh;
    }
    .box {
      max-width: 500px;
      margin: 30px auto;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: #667eea;
      text-align: center;
      margin-bottom: 20px;
    }
    select, button, input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      box-sizing: border-box;
      transition: all 0.3s;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn-group button {
      margin: 0;
    }
    .btn-error {
      grid-column: 1 / -1;
      background: #ff6b6b;
    }
    .btn-error:hover {
      background: #ee5a52;
    }
    .question {
      font-size: 22px;
      margin: 20px 0;
      padding: 20px;
      font-weight: bold;
      color: #333;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mc {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .mc button {
      background: #4CAF50;
      margin: 0;
      padding: 15px;
      font-size: 17px;
    }
    .mc button:hover {
      background: #45a049;
    }
    #answer {
      display: block;
      font-size: 18px;
    }
    .hide {
      display: none !important;
    }
    #feedback {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      transition: all 0.3s;
    }
    .feedback-correct {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    .feedback-wrong {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 16px;
    }
    .stats span {
      font-weight: bold;
      color: #667eea;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
  </style>
</head>

<body>

<div class="box">
  <h2>ğŸ‡¬ğŸ‡§ GB English Trainer â€“ More! 1</h2>

  <select id="unit">
    <option value="all">â­ Alle Units</option>
    <option value="1">Unit 1 - Classroom & Clothes</option>
    <option value="2">Unit 2 - Wildlife Park</option>
    <option value="3">Unit 3 - Pirates</option>
    <option value="4">Unit 4 - Feelings & Time</option>
    <option value="5">Unit 5 - Music & People</option>
    <option value="6">Unit 6 - Around Town</option>
    <option value="7">Unit 7 - Food & Eating</option>
  </select>

  <select id="direction">
    <option value="de-en">ğŸ‡©ğŸ‡ª Deutsch â†’ ğŸ‡¬ğŸ‡§ Englisch</option>
    <option value="en-de">ğŸ‡¬ğŸ‡§ Englisch â†’ ğŸ‡©ğŸ‡ª Deutsch</option>
    <option value="mix">ğŸ”€ Gemischt</option>
  </select>

  <select id="mode">
    <option value="write">âœï¸ Schreiben</option>
    <option value="mc">ğŸ¯ Multiple Choice</option>
    <option value="grammar">ğŸ“˜ Grammatik</option>
  </select>

  <div class="btn-group">
    <button onclick="startTrainer()">â–¶ï¸ Trainer</button>
    <button onclick="startTest()">ğŸ“ Test</button>
    <button class="btn-error" onclick="startErrorTrainer()">ğŸ” Fehler-Trainer (<span id="errorCount">0</span>)</button>
  </div>

  <div class="progress-bar hide" id="progressBar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <div class="question" id="question">ğŸ‘† WÃ¤hle einen Modus und klicke auf Start</div>

  <div id="mc" class="mc"></div>

  <input id="answer" placeholder="Antwort eingeben" class="hide">
  <button id="okBtn" onclick="checkAnswer()" class="hide">OK âœ“</button>

  <div id="feedback"></div>

  <div class="stats hide" id="stats">
    <div>âœ… Richtig: <span id="correctCount">0</span></div>
    <div>âŒ Falsch: <span id="wrongCount">0</span></div>
    <div>ğŸ“Š Quote: <span id="percentage">0%</span></div>
  </div>
</div>

<script src="vocab.js"></script>
<script src="grammar.js"></script>

<script>
let pool = [];
let originalPool = [];
let current = null;
let wrong = [];
let correct = 0;
let incorrect = 0;
let totalQuestions = 0;

function updateStats() {
  document.getElementById("correctCount").innerText = correct;
  document.getElementById("wrongCount").innerText = incorrect;
  document.getElementById("errorCount").innerText = wrong.length;
  
  const total = correct + incorrect;
  const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
  document.getElementById("percentage").innerText = percentage + "%";
  
  // Fortschrittsbalken aktualisieren
  if (totalQuestions > 0) {
    const progress = ((totalQuestions - pool.length) / totalQuestions) * 100;
    document.getElementById("progressFill").style.width = progress + "%";
  }
}

function startTrainer() {
  wrong = [];
  correct = 0;
  incorrect = 0;
  preparePool();
  totalQuestions = pool.length;
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  updateStats();
  nextQuestion();
}

function startTest() {
  wrong = [];
  correct = 0;
  incorrect = 0;
  preparePool();
  totalQuestions = pool.length;
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  updateStats();
  nextQuestion();
}

function startErrorTrainer() {
  if (wrong.length === 0) {
    alert("Keine Fehler vorhanden! ğŸ‰");
    return;
  }
  
  pool = [...wrong];
  totalQuestions = pool.length;
  correct = 0;
  incorrect = 0;
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  updateStats();
  nextQuestion();
}

function preparePool() {
  const unit = document.getElementById("unit").value;
  const mode = document.getElementById("mode").value;

  if (mode === "grammar") {
    pool = [...getGrammarForUnit(unit)];
  } else {
    pool = [...getVocabForUnit(unit)];
  }
  
  originalPool = [...pool];
}

function nextQuestion() {
  if (pool.length === 0) {
    showFinalResults();
    return;
  }

  current = pool[Math.floor(Math.random() * pool.length)];
  document.getElementById("feedback").innerText = "";
  document.getElementById("feedback").className = "";
  document.getElementById("answer").value = "";
  document.getElementById("mc").innerHTML = "";

  const mode = document.getElementById("mode").value;

  /* ===== GRAMMATIK ===== */
  if (mode === "grammar") {
    document.getElementById("question").innerText = current.q;
    current.solution = current.a;
    
    document.getElementById("answer").classList.add("hide");
    document.getElementById("okBtn").classList.add("hide");
    showGrammarOptions(current.options, current.a);
    return;
  }

  /* ===== VOKABELN ===== */
  const dir = document.getElementById("direction").value;

  let q = current.de;
  let a = current.en;

  if (dir === "en-de") [q, a] = [a, q];
  if (dir === "mix" && Math.random() > 0.5) [q, a] = [a, q];

  current.solution = a;
  document.getElementById("question").innerText = q;

  if (mode === "mc") {
    document.getElementById("answer").classList.add("hide");
    document.getElementById("okBtn").classList.add("hide");
    showMC(a, dir);
  } else {
    document.getElementById("answer").classList.remove("hide");
    document.getElementById("okBtn").classList.remove("hide");
    document.getElementById("answer").focus();
  }
}

function showGrammarOptions(options, correct) {
  const mc = document.getElementById("mc");
  
  options.forEach(opt => {
    const b = document.createElement("button");
    b.innerText = opt;
    b.onclick = () => checkAnswer(opt);
    mc.appendChild(b);
  });
}

function showMC(correct, dir) {
  const mc = document.getElementById("mc");
  let options = [correct];

  while (options.length < 4 && pool.length >= 4) {
    const r = pool[Math.floor(Math.random() * pool.length)];
    let candidate = r.en;

    if (dir === "en-de") candidate = r.de;
    if (!options.includes(candidate) && candidate !== correct) {
      options.push(candidate);
    }
  }

  options.sort(() => Math.random() - 0.5);

  options.forEach(o => {
    const b = document.createElement("button");
    b.innerText = o;
    b.onclick = () => checkAnswer(o);
    mc.appendChild(b);
  });
}

function checkAnswer(value = null) {
  const input = value || document.getElementById("answer").value.trim();
  const solution = current.solution;

  if (!solution || !input) return;

  const feedback = document.getElementById("feedback");

  if (isSimilar(input, solution)) {
    feedback.innerText = "âœ… Richtig!";
    feedback.className = "feedback-correct";
    correct++;
    
    // Frage aus Pool entfernen
    pool = pool.filter(item => item !== current);
  } else {
    feedback.innerText = "âŒ Falsch â€“ Richtig wÃ¤re: " + solution;
    feedback.className = "feedback-wrong";
    incorrect++;
    
    // Nur hinzufÃ¼gen wenn noch nicht in wrong
    if (!wrong.includes(current)) {
      wrong.push(current);
    }
  }

  updateStats();
  setTimeout(nextQuestion, 1200);
}

function showFinalResults() {
  const total = correct + incorrect;
  const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
  
  let emoji = "ğŸ‰";
  let message = "Fertig!";
  
  if (percentage === 100) {
    emoji = "ğŸ†";
    message = "Perfekt!";
  } else if (percentage >= 80) {
    emoji = "ğŸŒŸ";
    message = "Super gemacht!";
  } else if (percentage >= 60) {
    emoji = "ğŸ‘";
    message = "Gut gemacht!";
  } else {
    emoji = "ğŸ’ª";
    message = "Weiter Ã¼ben!";
  }
  
  document.getElementById("question").innerText = 
    `${emoji} ${message}\n${correct} von ${total} richtig (${percentage}%)`;
  
  document.getElementById("mc").innerHTML = "";
  document.getElementById("answer").classList.add("hide");
  document.getElementById("okBtn").classList.add("hide");
  document.getElementById("progressFill").style.width = "100%";
}

function isSimilar(a, b) {
  a = a.toLowerCase().trim();
  b = b.toLowerCase().trim();
  
  // Exakte Ãœbereinstimmung
  if (a === b) return true;
  
  let diff = Math.abs(a.length - b.length);

  for (let i = 0; i < Math.min(a.length, b.length); i++) {
    if (a[i] !== b[i]) diff++;
  }
  
  // Erlaube 1 Tippfehler
  return diff <= 1;
}

document.getElementById("answer").addEventListener("keydown", e => {
  if (e.key === "Enter") checkAnswer();
});
</script>

</body>
</html>
