<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>GB English Trainer ‚Äì More! 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 10px;
      min-height: 100vh;
    }
    .box {
      max-width: 500px;
      margin: 20px auto;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: #667eea;
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }
    select, button, input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      box-sizing: border-box;
      transition: all 0.3s;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn-group button {
      margin: 0;
    }
    .btn-test {
      background: #ff6b6b;
    }
    .btn-test:hover {
      background: #ee5a52;
    }
    .btn-error {
      grid-column: 1 / -1;
      background: #ffa500;
    }
    .btn-error:hover:not(:disabled) {
      background: #ff8c00;
    }
    .btn-reset {
      grid-column: 1 / -1;
      background: #ffa500;
      margin-top: 10px;
    }
    .btn-reset:hover {
      background: #ff8c00;
    }
    .question {
      font-size: 22px;
      margin: 20px 0;
      padding: 20px;
      font-weight: bold;
      color: #333;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .speak-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: #4CAF50;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
      width: auto;
      margin: 0;
    }
    .speak-btn:hover {
      background: #45a049;
      transform: translateY(-50%) scale(1.1);
    }
    .mc {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .mc button {
      background: #4CAF50;
      margin: 0;
      padding: 15px;
      font-size: 17px;
    }
    .mc button:hover:not(:disabled) {
      background: #45a049;
    }
    .mc button.correct {
      background: #28a745;
      animation: pulse 0.5s;
    }
    .mc button.wrong {
      background: #dc3545;
      animation: shake 0.5s;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    #answer {
      display: block;
      font-size: 18px;
    }
    .hide {
      display: none !important;
    }
    #feedback {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      transition: all 0.3s;
    }
    .feedback-correct {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    .feedback-wrong {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 16px;
    }
    .stats span {
      font-weight: bold;
      color: #667eea;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease;
    }
    .timer {
      text-align: center;
      font-size: 18px;
      margin: 10px 0;
      color: #667eea;
      font-weight: bold;
    }
    .streak {
      text-align: center;
      font-size: 20px;
      margin: 10px 0;
      padding: 10px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 8px;
      font-weight: bold;
    }
    .final-screen {
      text-align: center;
      padding: 20px;
    }
    .final-screen h3 {
      font-size: 32px;
      margin: 20px 0;
      color: #667eea;
    }
    .final-stats {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .final-stats div {
      margin: 10px 0;
      font-size: 18px;
    }
    .grade-display {
      font-size: 64px;
      font-weight: bold;
      margin: 20px 0;
      padding: 30px;
      border-radius: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .sound-toggle {
      position: absolute;
      top: 15px;
      right: 65px;
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      padding: 8px 12px;
      font-size: 20px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      width: auto;
    }
    .sound-toggle:hover {
      background: #667eea;
      color: white;
      transform: none;
    }
    .achievements-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      border: 2px solid #ffa500;
      color: #ffa500;
      padding: 8px 12px;
      font-size: 20px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      width: auto;
    }
    .achievements-btn:hover {
      background: #ffa500;
      color: white;
      transform: none;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #999;
    }
    .modal-close:hover {
      color: #333;
    }
    .achievement {
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .achievement.unlocked {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      box-shadow: 0 4px 12px rgba(253, 203, 110, 0.4);
    }
    .achievement-icon {
      font-size: 48px;
    }
    .achievement.locked .achievement-icon {
      filter: grayscale(100%);
      opacity: 0.3;
    }
    .achievement-info {
      flex: 1;
      text-align: left;
    }
    .achievement-title {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 5px;
    }
    .achievement-desc {
      font-size: 14px;
      color: #666;
    }
    .progress-overview {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
    }
    .progress-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 16px;
    }
    .progress-item strong {
      color: #667eea;
    }
    @media (max-width: 600px) {
      .box {
        margin: 10px;
        padding: 15px;
      }
      h2 {
        font-size: 20px;
      }
      .question {
        font-size: 18px;
        padding: 15px;
      }
      .sound-toggle {
        top: 10px;
        right: 60px;
        padding: 6px 10px;
        font-size: 18px;
      }
      .achievements-btn {
        top: 10px;
        right: 10px;
        padding: 6px 10px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>

<div class="box">
  <button class="sound-toggle" onclick="toggleSound()" id="soundBtn">üîä</button>
  <button class="achievements-btn" onclick="showAchievements()" id="achieveBtn">üèÜ</button>
  
  <h2>üá¨üáß GB English Trainer ‚Äì More! 1</h2>

  <select id="unit">
    <option value="all">‚≠ê Alle Units</option>
    <option value="1">Unit 1 - Classroom & Clothes</option>
    <option value="2">Unit 2 - Wildlife Park</option>
    <option value="3">Unit 3 - Pirates</option>
    <option value="4">Unit 4 - Feelings & Time</option>
    <option value="5">Unit 5 - Music & People</option>
    <option value="6">Unit 6 - Around Town</option>
    <option value="7">Unit 7 - Food & Eating</option>
  </select>

  <select id="direction">
    <option value="de-en">üá©üá™ Deutsch ‚Üí üá¨üáß Englisch</option>
    <option value="en-de">üá¨üáß Englisch ‚Üí üá©üá™ Deutsch</option>
    <option value="mix">üîÄ Gemischt</option>
  </select>

  <select id="mode">
    <option value="write">‚úèÔ∏è Schreiben</option>
    <option value="mc">üéØ Multiple Choice</option>
    <option value="grammar">üìò Grammatik</option>
  </select>

  <div class="btn-group">
    <button onclick="startTrainer()">‚ñ∂Ô∏è Trainer</button>
    <button class="btn-test" onclick="startTest()">üìù Test (20 Fragen)</button>
    <button class="btn-error" onclick="startErrorTrainer()" id="errorBtn" disabled>üîÅ Fehler-Trainer (<span id="errorCount">0</span>)</button>
  </div>

  <div class="timer hide" id="timer">‚è±Ô∏è Zeit: <span id="timeDisplay">0:00</span></div>
  <div class="streak hide" id="streak">üî• Serie: <span id="streakCount">0</span> richtig in Folge!</div>

  <div class="progress-bar hide" id="progressBar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <div class="question" id="question">
    üëÜ W√§hle einen Modus und klicke auf Start
  </div>

  <div id="mc" class="mc"></div>

  <input id="answer" placeholder="Antwort eingeben (Enter zum Best√§tigen)" class="hide" autocomplete="off">
  <button id="okBtn" onclick="checkAnswer()" class="hide">OK ‚úì</button>

  <div id="feedback"></div>

  <div class="stats hide" id="stats">
    <div>‚úÖ Richtig: <span id="correctCount">0</span></div>
    <div>‚ùå Falsch: <span id="wrongCount">0</span></div>
    <div>üìä Quote: <span id="percentage">0%</span></div>
  </div>

  <div id="finalScreen" class="hide"></div>
</div>

<!-- Achievements Modal -->
<div id="achievementsModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeAchievements()">&times;</span>
    <h2 style="color: #667eea; text-align: center;">üèÜ Erfolge & Fortschritt</h2>
    
    <div class="progress-overview">
      <h3 style="margin-top: 0;">üìä Deine Statistiken</h3>
      <div class="progress-item">
        <span>Gesamte Fragen beantwortet:</span>
        <strong><span id="totalAnswered">0</span></strong>
      </div>
      <div class="progress-item">
        <span>Richtig beantwortet:</span>
        <strong><span id="totalCorrect">0</span></strong>
      </div>
      <div class="progress-item">
        <span>Erfolgsquote:</span>
        <strong><span id="totalPercentage">0%</span></strong>
      </div>
      <div class="progress-item">
        <span>Tests absolviert:</span>
        <strong><span id="testsCompleted">0</span></strong>
      </div>
    </div>

    <h3 style="color: #667eea;">üèÖ Erfolge</h3>
    <div id="achievementsList"></div>
  </div>
</div>

<script src="vocab.js"></script>
<script src="grammar.js"></script>

<script>
let pool = [];
let current = null;
let wrong = [];
let correct = 0;
let incorrect = 0;
let totalQuestions = 0;
let streak = 0;
let maxStreak = 0;
let startTime = null;
let timerInterval = null;
let soundEnabled = true;
let isActive = false;
let isTestMode = false;

// Fortschritts-Speicherung
let progress = {
  totalAnswered: 0,
  totalCorrect: 0,
  totalIncorrect: 0,
  testsCompleted: 0,
  unlockedAchievements: [],
  newAchievements: []
};

// Achievements Definition
const ACHIEVEMENTS = [
  { id: 'first_correct', icon: 'üéØ', title: 'Erste Schritte', desc: '1 Frage richtig', requirement: 1, type: 'correct' },
  { id: 'ten_correct', icon: '‚≠ê', title: 'Gut dabei!', desc: '10 Fragen richtig', requirement: 10, type: 'correct' },
  { id: 'fifty_correct', icon: 'üåü', title: 'Super Lerner', desc: '50 Fragen richtig', requirement: 50, type: 'correct' },
  { id: 'hundred_correct', icon: 'üí´', title: 'Jahrhundert!', desc: '100 Fragen richtig', requirement: 100, type: 'correct' },
  { id: 'streak_5', icon: 'üî•', title: 'Hei√üe Serie', desc: '5 richtig in Folge', requirement: 5, type: 'streak' },
  { id: 'streak_10', icon: 'üî•üî•', title: 'Unaufhaltbar', desc: '10 richtig in Folge', requirement: 10, type: 'streak' },
  { id: 'first_test', icon: 'üìù', title: 'Testpilot', desc: 'Ersten Test absolviert', requirement: 1, type: 'tests' },
  { id: 'five_tests', icon: 'üìö', title: 'Flei√üig!', desc: '5 Tests absolviert', requirement: 5, type: 'tests' },
  { id: 'perfect_test', icon: 'üèÜ', title: 'Perfekt!', desc: 'Test mit 100% bestanden', requirement: 1, type: 'perfect' },
  { id: 'grade_1', icon: 'ü•á', title: 'Sehr gut!', desc: 'Note 1 im Test', requirement: 1, type: 'grade1' }
];

function loadProgress() {
  const saved = localStorage.getItem('englishTrainerProgress');
  if (saved) {
    progress = JSON.parse(saved);
  }
}

function saveProgress() {
  localStorage.setItem('englishTrainerProgress', JSON.stringify(progress));
}

function checkAchievements() {
  progress.newAchievements = [];
  
  ACHIEVEMENTS.forEach(achievement => {
    if (progress.unlockedAchievements.includes(achievement.id)) return;
    
    let unlocked = false;
    
    switch(achievement.type) {
      case 'correct':
        unlocked = progress.totalCorrect >= achievement.requirement;
        break;
      case 'streak':
        unlocked = maxStreak >= achievement.requirement;
        break;
      case 'tests':
        unlocked = progress.testsCompleted >= achievement.requirement;
        break;
      case 'perfect':
        unlocked = isTestMode && correct === 20 && incorrect === 0;
        break;
      case 'grade1':
        unlocked = isTestMode && ((correct / (correct + incorrect)) * 100) >= 90;
        break;
    }
    
    if (unlocked) {
      progress.unlockedAchievements.push(achievement.id);
      progress.newAchievements.push(achievement);
    }
  });
  
  saveProgress();
}

function showAchievementNotification(achievement) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 2000;
    animation: slideIn 0.5s;
    max-width: 300px;
  `;
  notification.innerHTML = `
    <div style="font-size: 48px; text-align: center;">${achievement.icon}</div>
    <div style="font-weight: bold; font-size: 18px; margin: 10px 0; text-align: center;">Erfolg freigeschaltet!</div>
    <div style="font-size: 16px; text-align: center;">${achievement.title}</div>
    <div style="font-size: 14px; color: #666; text-align: center; margin-top: 5px;">${achievement.desc}</div>
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

function showAchievements() {
  document.getElementById('totalAnswered').innerText = progress.totalAnswered;
  document.getElementById('totalCorrect').innerText = progress.totalCorrect;
  const totalPerc = progress.totalAnswered > 0 
    ? Math.round((progress.totalCorrect / progress.totalAnswered) * 100) 
    : 0;
  document.getElementById('totalPercentage').innerText = totalPerc + '%';
  document.getElementById('testsCompleted').innerText = progress.testsCompleted;
  
  const list = document.getElementById('achievementsList');
  list.innerHTML = '';
  
  ACHIEVEMENTS.forEach(achievement => {
    const unlocked = progress.unlockedAchievements.includes(achievement.id);
    const div = document.createElement('div');
    div.className = 'achievement ' + (unlocked ? 'unlocked' : 'locked');
    div.innerHTML = `
      <div class="achievement-icon">${achievement.icon}</div>
      <div class="achievement-info">
        <div class="achievement-title">${achievement.title}</div>
        <div class="achievement-desc">${achievement.desc}</div>
      </div>
    `;
    list.appendChild(div);
  });
  
  document.getElementById('achievementsModal').classList.add('show');
}

function closeAchievements() {
  document.getElementById('achievementsModal').classList.remove('show');
}

function speak(text) {
  if (!soundEnabled || !text) return;
  if (/[√§√∂√º√ü]/.test(text)) return;
  
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-GB';
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);
  }
}

function addSpeakButton() {
  if (current && current.en && !current.options) {
    const questionDiv = document.getElementById('question');
    const existing = questionDiv.querySelector('.speak-btn');
    if (existing) existing.remove();
    
    const btn = document.createElement('button');
    btn.className = 'speak-btn';
    btn.innerHTML = 'üîä';
    btn.onclick = (e) => {
      e.stopPropagation();
      speak(current.solution);
    };
    questionDiv.appendChild(btn);
  }
}

loadProgress();

function playSound(type) {
  if (!soundEnabled) return;
  
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    if (type === 'correct') {
      oscillator.frequency.value = 800;
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    } else if (type === 'wrong') {
      oscillator.frequency.value = 200;
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } else if (type === 'finish') {
      oscillator.frequency.value = 600;
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }
  } catch(e) {
    console.log('Audio not supported');
  }
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundBtn').innerText = soundEnabled ? 'üîä' : 'üîá';
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timeDisplay').innerText = 
      `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function updateStats() {
  document.getElementById("correctCount").innerText = correct;
  document.getElementById("wrongCount").innerText = incorrect;
  document.getElementById("errorCount").innerText = wrong.length;
  
  const errorBtn = document.getElementById("errorBtn");
  errorBtn.disabled = wrong.length === 0;
  
  const total = correct + incorrect;
  const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
  document.getElementById("percentage").innerText = percentage + "%";
  
  if (totalQuestions > 0) {
    const progressVal = ((totalQuestions - pool.length) / totalQuestions) * 100;
    document.getElementById("progressFill").style.width = progressVal + "%";
  }
  
  if (streak >= 3) {
    document.getElementById("streakCount").innerText = streak;
    document.getElementById("streak").classList.remove("hide");
  } else {
    document.getElementById("streak").classList.add("hide");
  }
}

function startTrainer() {
  wrong = [];
  correct = 0;
  incorrect = 0;
  streak = 0;
  maxStreak = 0;
  isActive = true;
  isTestMode = false;
  preparePool();
  totalQuestions = pool.length;
  
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  document.getElementById("timer").classList.remove("hide");
  document.getElementById("finalScreen").classList.add("hide");
  
  startTimer();
  updateStats();
  nextQuestion();
}

function startTest() {
  wrong = [];
  correct = 0;
  incorrect = 0;
  streak = 0;
  maxStreak = 0;
  isActive = true;
  isTestMode = true;
  
  const unit = document.getElementById("unit").value;
  
  let vocabPool = getVocabForUnit(unit);
  let selectedVocab = [];
  for (let i = 0; i < 10 && vocabPool.length > 0; i++) {
    const randomIndex = Math.floor(Math.random() * vocabPool.length);
    selectedVocab.push(vocabPool[randomIndex]);
    vocabPool.splice(randomIndex, 1);
  }
  
  let grammarPool = getGrammarTasks(10);
  
  pool = [...selectedVocab, ...grammarPool].sort(() => Math.random() - 0.5);
  totalQuestions = pool.length;
  
  document.getElementById("stats").classList.remove("hide");
  document.getElementById("progressBar").classList.remove("hide");
  document.getElementById("timer").classList.remove("hide");
  document.getElementById("finalScreen").classList.add("hide");
  
  startTimer();
  updateStats();
  nextQuestion();
}

function startErrorTrainer() {
  if (wrong.length === 0) {
    alert("Keine Fehler vorhanden! üéâ");
    return;
  }
  
  pool = [...wrong];
  wrong = [];
  totalQuestions = pool.length;
  correct = 0;
  incorrect = 0;
  streak = 0;
  maxStreak
