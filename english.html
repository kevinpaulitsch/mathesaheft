<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>English Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#eef3ff}
.box{max-width:420px;margin:20px auto;background:#fff;
padding:20px;border-radius:10px}
select,button,input{width:100%;padding:10px;margin:6px 0;font-size:16px}
.question{font-size:20px;font-weight:bold;margin:10px 0}
.mc button{margin-top:6px}
.result{margin-top:15px;font-size:18px}
</style>
</head>

<body>
<div class="box">
<h2>English Trainer</h2>

<select id="mode">
  <option value="trainer">â–¶ Trainer (gemischt)</option>
  <option value="test">ğŸ“ Test (30 Aufgaben)</option>
  <option value="mc">ğŸ¯ Multiple Choice ONLY</option>
</select>

<select id="content">
  <option value="mix">Vokabeln + Grammatik</option>
  <option value="vocab">nur Vokabeln</option>
  <option value="grammar">nur Grammatik</option>
</select>

<select id="direction">
  <option value="mix">Gemischt</option>
  <option value="de-en">Deutsch â†’ Englisch</option>
  <option value="en-de">Englisch â†’ Deutsch</option>
</select>

<button onclick="start()">Start</button>

<div class="question" id="question">â¬… Start drÃ¼cken</div>
<div id="mc" class="mc"></div>
<input id="answer" placeholder="Antwort eingeben (falls Schreiben)">
<button onclick="submit()">OK</button>

<div id="result" class="result"></div>
</div>

<script src="vocab.js"></script>
<script src="grammar.js"></script>

<script>
let pool = [];
let current = null;
let index = 0;
let correct = 0;
const TEST_SIZE = 30;

/* ================= START ================= */
function start(){
  index = 0;
  correct = 0;
  document.getElementById("result").innerHTML = "";

  if(document.getElementById("mode").value === "test"){
    pool = buildMixedTestPool(TEST_SIZE);
  } else {
    pool = buildNormalPool();
  }

  next();
}

/* ============ POOLS ===================== */
function buildNormalPool(){
  const content=document.getElementById("content").value;
  let p=[];
  if(content==="vocab"||content==="mix"){
    p.push(...getVocabForUnit("all").map(v=>({type:"vocab",data:v})));
  }
  if(content==="grammar"||content==="mix"){
    p.push(...getGrammarTasks(50).map(g=>({type:"grammar",data:g})));
  }
  return shuffle(p);
}

function buildMixedTestPool(amount){
  const vocab = getVocabForUnit("all")
    .map(v=>({type:"vocab",data:v}));
  const grammar = getGrammarTasks(50)
    .map(g=>({type:"grammar",data:g}));

  return shuffle([...vocab, ...grammar]).slice(0, amount);
}

/* ============ NEXT QUESTION ============== */
function next(){
  const mode=document.getElementById("mode").value;

  if(index>=pool.length || (mode==="test" && index>=TEST_SIZE)){
    showResult();
    return;
  }

  document.getElementById("mc").innerHTML="";
  document.getElementById("answer").value="";
  current = pool[index];

  const counter = mode==="test"
    ? `(${index+1}/${TEST_SIZE}) `
    : `(${index+1}) `;

  /* -------- GRAMMAR -------- */
  if(current.type==="grammar"){
    document.getElementById("question").innerText =
      counter + current.data.q;
    showMC(current.data.options, current.data.a);
    return;
  }

  /* -------- VOCAB ---------- */
  let q=current.data.de, a=current.data.en;
  let dir=document.getElementById("direction").value;

  if(dir==="mix" && Math.random()>0.5) [q,a]=[a,q];
  if(dir==="en-de") [q,a]=[a,q];

  current.solution=a;
  document.getElementById("question").innerText =
    counter + "Ãœbersetze: " + q;

  if(mode==="mc" || Math.random()>0.5){
    showMC(buildVocabOptions(a), a);
  }
}

/* ============ MULTIPLE CHOICE ============= */
function showMC(options,solution){
  options.forEach(o=>{
    const b=document.createElement("button");
    b.innerText=o;
    b.onclick=()=>check(o,solution);
    document.getElementById("mc").appendChild(b);
  });
}

/* ============ CHECK ====================== */
function submit(){
  if(!current) return;
  check(document.getElementById("answer").value,
        current.solution || current.data.a);
}

function check(input,solution){
  if(similar(input,solution)) correct++;
  index++;
  next();
}

/* ============ RESULT ===================== */
function showResult(){
  if(document.getElementById("mode").value!=="test"){
    document.getElementById("question").innerText="Fertig ğŸ‘";
    return;
  }

  let note=5;
  if(correct>=28) note=1;
  else if(correct>=25) note=2;
  else if(correct>=22) note=3;
  else if(correct>=18) note=4;

  document.getElementById("question").innerHTML =
    "ğŸ“ Test beendet";
  document.getElementById("result").innerHTML =
    `Richtig: <b>${correct} / ${TEST_SIZE}</b><br>
     ğŸ“ Note: <b>${note}</b>`;
  document.getElementById("mc").innerHTML="";
}

/* ============ HELPERS ==================== */
function buildVocabOptions(correct){
  let opts=[correct];
  let all=getVocabForUnit("all");
  while(opts.length<4){
    let r=all[Math.floor(Math.random()*all.length)].en;
    if(!opts.includes(r)) opts.push(r);
  }
  return shuffle(opts);
}

function similar(a,b){
  a=(a||"").toLowerCase(); b=b.toLowerCase();
  let d=Math.abs(a.length-b.length);
  for(let i=0;i<Math.min(a.length,b.length);i++)
    if(a[i]!==b[i]) d++;
  return d<=1;
}

function shuffle(a){
  return a.map(x=>({x,r:Math.random()}))
    .sort((a,b)=>a.r-b.r)
    .map(o=>o.x);
}

document.getElementById("answer").addEventListener("keydown",
e=>{if(e.key==="Enter") submit();});
</script>
</body>
</html>
